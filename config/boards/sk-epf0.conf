# Rockchip Generic Board
BOARD_NAME="SK Experiment Platform 0"
BOARDFAMILY="rk35xx"
BOARD_MAINTAINER="Sergey Kharenko"
BOOTCONFIG="sk-epf0-rk3562_defconfig" # vendor name, not standard, see hook below, set BOOT_SOC below to compensate
BOOT_SOC="rk3562"
KERNEL_TARGET="vendor"
KERNEL_TEST_TARGET="vendor"
FULL_DESKTOP="yes"
# BOOT_LOGO="desktop"
BOOT_FDT_FILE="rockchip/rk3562-sk-epf0.dtb"
BOOT_SCENARIO="spl-blobs"
BOOT_SUPPORT_SPI="yes"
BOOT_SPI_RKSPI_LOADER="yes"
IMAGE_PARTITION_TABLE="gpt"
BOOTFS_TYPE="fat"

VENDOR="Intelli-FDK"
VENDORURL="https://www.hust.edu.cn/"
VENDORSUPPORT="https://github.com/SergeyKharenko"

function late_family_config__sk-epf0_change_to_private_config() {
	display_alert "$BOARD" "Change to use linux-rk35xx-vendor-sk-epf0.conf" "info"
	
	BOOTSOURCE='https://github.com/SergeyKharenko/u-boot.git'
	BOOTBRANCH='branch:sk-series'
	KERNELSOURCE='https://github.com/SergeyKharenko/linux-rockchip.git'
	KERNELBRANCH='branch:sk-series'
	LINUXCONFIG="linux-rk35xx-ifdk-lite"

	OVERLAY_PREFIX="sk-epf0"
	DEFAULT_OVERLAYS="sk-epf0-display-vga"

	return 0
}

function post_family_tweaks_bsp__sk-epf0() {
	display_alert "$BOARD" "Installing rk3568-bluetooth.service" "info"

	# a custom brcm_patchram_plus binary, plus a systemd service to run it at boot time
	install -m 755 $SRC/packages/blobs/bt/brcm_patchram_plus/brcm_patchram_plus_arm64 $destination/usr/bin
	cp $SRC/packages/bsp/rk3399/rk3399-bluetooth.service $destination/lib/systemd/system/rk3568-bluetooth.service

	sed -i 's/brcm_patchram_plus_rk3399/brcm_patchram_plus_arm64/g' $destination/lib/systemd/system/rk3568-bluetooth.service
	sed -i 's/ttyS0/ttyS8/g' $destination/lib/systemd/system/rk3568-bluetooth.service
	return 0
}

function post_family_tweaks__sk-epf0_naming_audios() {
	display_alert "$BOARD" "Renaming sk-epf0 audio" "info"

	mkdir -p $SDCARD/etc/udev/rules.d/
	echo 'SUBSYSTEM=="sound", ENV{ID_PATH}=="platform-rk809-sound", ENV{SOUND_DESCRIPTION}="RK809 Audio"' >> $SDCARD/etc/udev/rules.d/90-naming-audios.rules

	return 0
}

function post_family_tweaks__sk-epf0_enable_services() {
	display_alert "$BOARD" "Enabling rk3568-bluetooth.service" "info"
	chroot_sdcard systemctl enable rk3568-bluetooth.service
	return 0
}

# function post_family_tweaks__sk-epf0_install_basic_packs() {
#     display_alert "$BOARD" "Installing Basic Packs" "info"

#     # Core development toolchain & build utilities
#     chroot_sdcard_apt_get_install \
#         wget git curl meson \
#         g++ gdb clang \
# 		gdbserver \
#         build-essential \
#         cmake cmake-gui ninja-build ccache \
#         pkg-config \
#         libc6-dev libstdc++-12-dev

#     # Common system libraries & general-purpose dependencies
#     chroot_sdcard_apt_get_install \
# 		libb2-dev \
#         libssl-dev \
# 		libts-dev \
#         libz-dev zlib1g-dev \
#         libudev-dev \
#         libfontconfig-dev \
# 		libfreetype6-dev \
#         libicu-dev \
# 		libhunspell-dev \
#         libsqlite3-dev libsqlitecpp-dev \
#         libdbus-1-dev libdbus-c++-dev \
#         libmd4c-dev libmd4c-html0-dev

#     # Graphics stack: DRM / EGL / GLES / X11 / input
#     chroot_sdcard_apt_get_install \
#         libdrm-dev \
#         libgbm-dev \
#         libegl1-mesa-dev libegl-dev \
#         libgles2-mesa libgles2-mesa-dev \
# 		libinput-dev \
# 		libx11-dev \
# 		libx11-xcb-dev \
# 		libxrandr-dev \
# 		libxext-dev \
# 		libxfixes-dev \
# 		libxi-dev \
# 		libxrender-dev \
# 		libxcb-* \
# 		libxkbcommon-dev \
# 		libxkbcommon-x11-dev \
# 		x11proto-xext-dev

#     # Image / text rendering related libraries
#     chroot_sdcard_apt_get_install \
#         libharfbuzz-dev \
#         libjpeg-dev libpng-dev libtiff-dev \
#         libgdk-pixbuf2.0-0

#     # GStreamer / multimedia / audio stack
#     chroot_sdcard_apt_get_install \
#         libgstreamer1.0-dev \
#         libgstreamer-plugins-base1.0-dev \
# 		libgstreamer-plugins-bad1.0-dev \
#         libgstreamermm-1.0-dev \
#         libpulse-dev

#     # Graphics benchmark and Mesa utilities
#     chroot_sdcard_apt_get_install \
#         glmark2-es2-drm glmark2-es2-x11 \
#         mesa-utils mesa-utils-extra
# }

# function post_family_tweaks__sk-ifdk-lite_install_media_stack() {
# 	display_alert "$BOARD" "Installing librga/mpp/gstreamer-rockchip" "info"

# 	cp $SRC/packages/bsp/rockchip/setup_media_stack.sh $SDCARD/
# 	chmod +x $SDCARD/setup_media_stack.sh
# 	chroot_sdcard /bin/bash /setup_media_stack.sh
# 	rm $SDCARD/setup_media_stack.sh

# 	cp $SRC/packages/bsp/rockchip/50-dma-heap.rules $SDCARD/etc/udev/rules.d/
# 	cp $SRC/packages/bsp/rockchip/50-mpp.rules $SDCARD/etc/udev/rules.d/
# 	cp $SRC/packages/bsp/rockchip/50-rga.rules $SDCARD/etc/udev/rules.d/

# 	return 0
# }

function pre_config_uboot_target__sk-epf0_patch_rockchip_common_boot_order() {
	declare -a rockchip_uboot_targets=("usb" "mmc1" "mmc0") # for future make-this-generic delight
	display_alert "u-boot for ${BOARD}/${BRANCH}" "u-boot: adjust boot order to '${rockchip_uboot_targets[*]}'" "info"
	sed -i -e "s/#define BOOT_TARGETS.*/#define BOOT_TARGETS \"${rockchip_uboot_targets[*]}\"/" include/configs/rockchip-common.h
	regular_git diff -u include/configs/rockchip-common.h || true
}

function post_post_debootstrap_tweaks__sk-epf0_setup_apt_sources() {
	display_alert "$BOARD" "Configuring APT sources" "info"
	cp -f $SRC/packages/bsp/sk-ifdk/armbian.sources $SDCARD/etc/apt/sources.list.d/
	cp -f $SRC/packages/bsp/sk-ifdk/debian.sources $SDCARD/etc/apt/sources.list.d/
	rm $SDCARD/etc/apt/sources.list.d/armbian-config.sources
}

# Include fw_setenv, configured to point to the correct spot on the SPI Flash
PACKAGE_LIST_BOARD="libubootenv-tool" # libubootenv-tool provides fw_printenv and fw_setenv, for talking to U-Boot environment
